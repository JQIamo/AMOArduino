<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.8"/>
<title>JQI Arduino Libraries: SetListArduino</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="180px-JQI_logo_boxed.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">JQI Arduino Libraries
   </div>
   <div id="projectbrief">Arduino for the modern scientist.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.8 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title"><a class="el" href="class_set_list_arduino.html" title="Primary &quot;front-facing&quot; class for the SetListArduino library. ">SetListArduino</a> </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2>Overview</h2>
<p><a class="el" href="class_set_list_arduino.html" title="Primary &quot;front-facing&quot; class for the SetListArduino library. ">SetListArduino</a> is an Arduino library designed to provide easy integration for Arduino-controlled devices into the SetList computer control software used at the JQI. To set up a new Arduino device for SetList control, simply "register" the device with <a class="el" href="class_set_list_arduino.html" title="Primary &quot;front-facing&quot; class for the SetListArduino library. ">SetListArduino</a> in your sketch, and provide as many callback functions as you need to implement the desired functionality. <a class="el" href="class_set_list_arduino.html" title="Primary &quot;front-facing&quot; class for the SetListArduino library. ">SetListArduino</a> orchestrates the communication between LabView's SetList and each registered device, executing the appropriate callback function for each new line passed from SetList.</p>
<p>For examples and more details, see below!</p>
<h2>Example Sketch</h2>
<p>Here is a short sketch to illustrate how one might integrate an <a class="el" href="class_a_d9954.html">AD9954</a> DDS board.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;SPI.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="_a_d9954_8h.html">AD9954.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="_set_list_arduino_8h.html">SetListArduino.h</a>&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="comment">// Instantiate setlist object.</span></div>
<div class="line"><span class="comment">// Note, it must be called SetListImage for trigger interrupts to work.</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define triggerChannel 13</span></div>
<div class="line"><a class="code" href="class_set_list_arduino.html">SetListArduino</a> <a class="code" href="_set_list_arduino_8cpp.html#a457186a9c749dbc66614fd861f87655a">SetListImage</a>(triggerChannel); </div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">// Instantiate DDS object, using the AD9954 library.</span></div>
<div class="line"><span class="comment">// Exact instantiation depends on how DDS is connected.</span></div>
<div class="line"><span class="comment">// This could just as easily be any other device the </span></div>
<div class="line"><span class="comment">// Arduino knows how to communicate with, or even the</span></div>
<div class="line"><span class="comment">// digital/analog outputs of the Arduino itself! </span></div>
<div class="line"><span class="comment">// SetListArduino is completely device-agnostic, which </span></div>
<div class="line"><span class="comment">// allows for easy extensibility.</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define D1IOUPDATE 2</span></div>
<div class="line"><span class="preprocessor">#define D1PS1 3</span></div>
<div class="line"><span class="preprocessor">#define D1PS0 4</span></div>
<div class="line"><span class="preprocessor">#define D1OSK 5</span></div>
<div class="line"><span class="preprocessor">#define D1SS 6</span></div>
<div class="line"><span class="preprocessor">#define D1RESET 7</span></div>
<div class="line"></div>
<div class="line"><a class="code" href="class_a_d9954.html">AD9954</a> DDS(D1SS, D1RESET, D1IOUPDATE, D1PS0, D1PS1, D1OSK);    </div>
<div class="line"></div>
<div class="line"><span class="comment">// Callback function to set a particular DDS frequency</span></div>
<div class="line"><span class="comment">// We know that LabView will pass a single parameter for the frequency, thus</span></div>
<div class="line"><span class="comment">// we want to pull freq = params[0].</span></div>
<div class="line"><span class="keywordtype">void</span> setDDSFreq(<a class="code" href="class_a_d9954.html">AD9954</a> * dds, <span class="keywordtype">int</span> * params){</div>
<div class="line">    dds-&gt;<a class="code" href="class_a_d9954.html#a6f1215b712be7981ccad3fcc550b321f">setFreq</a>(params[0]);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Callback function to initiate a DDS ramp.</span></div>
<div class="line"><span class="comment">// Say we set this up so LabView will pass the parameters </span></div>
<div class="line"><span class="comment">// [freq0, freq1, tau] where tau is the ramp time.</span></div>
<div class="line"><span class="comment">// Here, we do a few calculations, initialize the pins, and call linearSweep</span></div>
<div class="line"><span class="comment">// on the DDS. The Arduino is controlling PS0 to do the sweep; see AD9954</span></div>
<div class="line"><span class="comment">// for details.</span></div>
<div class="line"><span class="keywordtype">void</span> rampDDS(<a class="code" href="class_a_d9954.html">AD9954</a> * dds, <span class="keywordtype">int</span> * params){</div>
<div class="line">    <span class="keywordtype">int</span> f0 = params[0];</div>
<div class="line">    <span class="keywordtype">int</span> f1 = params[1];</div>
<div class="line">    <span class="keywordtype">int</span> tau = params[2];</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">double</span> rampRate;</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">int</span> delta = f1 - f0;    <span class="comment">// calculate delta frequency</span></div>
<div class="line">    <span class="keywordtype">int</span> RR = 1;             <span class="comment">// number of SYS_CLK cycles to spend at each</span></div>
<div class="line">                            <span class="comment">// intermediate frequency</span></div>
<div class="line">    rampRate = ((double) delta)/tau;   <span class="comment">// Hz per second</span></div>
<div class="line">    <span class="keywordtype">int</span> posDF = (int)(rampRate * RR * 100E-9);   <span class="comment">// calculate posDF for DDS</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">// this is implemented in the AD9954 library; see that</span></div>
<div class="line">    <span class="comment">// documentation for details.</span></div>
<div class="line"></div>
<div class="line">    dds-&gt;<a class="code" href="class_a_d9954.html#a26d0f9e3f3053ffecdb58d1900a755de">linearSweep</a>(f0, f1, posDF, RR, posDF, RR);</div>
<div class="line">    digitalWrite(D1PS1, HIGH);  <span class="comment">// DDS starts sweeping...</span></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> setup(){</div>
<div class="line"></div>
<div class="line">    Serial.begin(9600);</div>
<div class="line"></div>
<div class="line">    SPI.begin();</div>
<div class="line">    SPI.setClockDivider(4);</div>
<div class="line">    SPI.setDataMode(SPI_MODE0);</div>
<div class="line"></div>
<div class="line">    DDS.initialize(400000000);  <span class="comment">// Start DDS with 400MHz clock</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">/*****************************************</span></div>
<div class="line"><span class="comment">        SetListArduino Part!</span></div>
<div class="line"><span class="comment">    ******************************************/</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">// Register the DDS device with SetListImage.</span></div>
<div class="line">    <span class="comment">// First argument is device (passed by reference);</span></div>
<div class="line">    <span class="comment">// Second argument is the &quot;channel number&quot;, which must match</span></div>
<div class="line">    <span class="comment">// what you entered in LabView. See README for more details.</span></div>
<div class="line">    <a class="code" href="_set_list_arduino_8cpp.html#a457186a9c749dbc66614fd861f87655a">SetListImage</a>.<a class="code" href="class_set_list_arduino.html#a684eb215a00c94d6c2113ef7a61be096">registerDevice</a>(DDS, 0);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Register as many callback functions as you need...</span></div>
<div class="line">    <span class="comment">// This says the short-command &quot;f&quot; on channel 0 should execute</span></div>
<div class="line">    <span class="comment">// the callback function setDDSFreq().</span></div>
<div class="line">    <a class="code" href="_set_list_arduino_8cpp.html#a457186a9c749dbc66614fd861f87655a">SetListImage</a>.<a class="code" href="class_set_list_arduino.html#a632bd0e945344749143fbe7dbb138a01">registerCommand</a>(<span class="stringliteral">&quot;f&quot;</span>, 0, setDDSFreq);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Here is another callback function, providing a method to </span></div>
<div class="line">    <span class="comment">// execute DDS ramps. Note, the short-command is different, but</span></div>
<div class="line">    <span class="comment">// we still want this functionality for our DDS on channel 0.</span></div>
<div class="line">    <span class="comment">// If we had a second DDS, say on channel 1, we would have to do a </span></div>
<div class="line">    <span class="comment">// second SetListImage.registerCommand(&quot;r&quot;, 1, rampDDS);</span></div>
<div class="line">    <a class="code" href="_set_list_arduino_8cpp.html#a457186a9c749dbc66614fd861f87655a">SetListImage</a>.<a class="code" href="class_set_list_arduino.html#a632bd0e945344749143fbe7dbb138a01">registerCommand</a>(<span class="stringliteral">&quot;r&quot;</span>, 0, rampDDS);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> loop(){</div>
<div class="line">    <a class="code" href="_set_list_arduino_8cpp.html#a457186a9c749dbc66614fd861f87655a">SetListImage</a>.<a class="code" href="class_set_list_arduino.html#a13ae88af6c307c7a1784cce29b1b8de8">readSerial</a>();  <span class="comment">// listen for &amp; process serial commands </span></div>
<div class="line">                                <span class="comment">// from computer</span></div>
<div class="line">}</div>
</div><!-- fragment --><h1>Temporary Notes; clean up and integrate!</h1>
<ul>
<li>can't have an arduino-controlled ramp line on first line of setlist</li>
</ul>
<p>Why? because currently it should put the devices into the state of the first setlist line as soon as labview calls "$". However, check that this is actually implemented in the library code. Also maybe think of a better way to trigger the start of a run, so this isn't a problem...</p>
<h2>Original Description</h2>
<p>Basic definitions of what I want to implement:</p>
<p>Arduino devices are triggered by Slaved Digital channels from SetList. This means they get at most one trigger per line. As envisioned, SetList will only provide a trigger pulse when the Arduino needs to step to the next output value.</p>
<p>Currently, we have the Arduino controlling a few different devices in the lab.</p>
<ul>
<li>DDS boards<ul>
<li>Output single-tone frequencies</li>
<li>Output linear frequency sweeps</li>
<li>More complex functionality can be implemented (see <a class="el" href="class_a_d9954.html">AD9954</a> library).</li>
</ul>
</li>
<li><a class="el" href="class_a_d536x.html">AD536x</a> DACs<ul>
<li>Library still needs some polishing; control 8- or 16-channel DAC chips from Analog Devices.</li>
<li>Again, could output single voltage or interpolated sweep. However, the intention here is to use these for analog channels that don't need updating during a cycle.</li>
</ul>
</li>
</ul>
<p>All of this to say, what functionality should the SetList library include?</p>
<p>The SerialCommand library provides a nice hook for delegating serial commands to specific functions. Either re-factor this into <a class="el" href="class_set_list_arduino.html" title="Primary &quot;front-facing&quot; class for the SetListArduino library. ">SetListArduino</a>, or incorporate it. Need to figure out exactly how the "Native USB" arduinos handle serial communication, or if there is still some optimization that can be done?</p>
<p>Ok, here's a swing at some software definition use cases:</p>
<p>In an Arduino sketch, the user should be able to define an array of "controlled devices" which the Arduino is connected to.</p>
<p>For each controlled device, the user should be able to map "short commands" from the serial interface to setter methods on the device. The arguments (see eg SerialCommand library) should come in the same order as required by the device setter function.</p>
<p>In LabView, the user should be able to parse the SetList table into a list of serial commands to send to the Arduino. A block of serial commands should be prefaced by "@ (int) DeviceUID (int) numCommands", where the DeviceUID corresponds to an array index of the controlled devices array, and numCommands corresponds to the number of commands it is expecting.</p>
<p>Once LabView specifies the device and number of commands it will send, it loops through and sends each command.</p>
<p>After the commands have been sent, LabView should indicate the device should be initiated. Arduino will program that device to the state given by the first command, and wait for the first falling edge of its Slaved Digital line to begin stepping through a command list.</p>
<p>LabView should require the Slaved Digital line to be high on the first step of a cycle; this way, Arduino can wait for a falling edge to know the cycle has started. Arduino will then switch interrupt routines to listen for a change on that pin, and call the setter method for each of the controlled devices as necessary.</p>
<p>Question: for an Arduino controlling multiple devices, do we use multiple Slaved Digital pseudo-triggers, or somehow negotiate the updating with a single trigger line?</p>
<p>Here's a better idea for a more general <a class="el" href="class_set_list_arduino.html" title="Primary &quot;front-facing&quot; class for the SetListArduino library. ">SetListArduino</a> device:</p>
<ul>
<li>LabView implements the class Device &gt; Arduino, which has variable number of "channels," each of which can have a variable number of Columns (regular or digital) configurable by the user.</li>
<li>One of these columns can specify a short command; eg, "r" for ramp or "f" for frequency output. If only one type of behavior is allowed (eg, "voltage" output), then user can configure a default short command.</li>
<li>LabView's Arduino class</li>
<li>The user, in setting up the device, now just has to negotiate command mappings to controlled devices' setter functions. eg:</li>
</ul>
<p><a class="el" href="class_set_list_arduino.html#a632bd0e945344749143fbe7dbb138a01" title="Registers a callback command with SetListArduino, associated with a particular device channel...">SetListArduino.registerCommand</a>("f", channelNum, &amp;setFreq, argumentNum);</p>
<p>Now, upon encountering short command "f", <a class="el" href="class_set_list_arduino.html" title="Primary &quot;front-facing&quot; class for the SetListArduino library. ">SetListArduino</a> would parse out however many arguments are expected by argumentNum, pass that to setFreq, and apply it to the controlled device in the specified channelNum.</p>
<p>To deal with timing issues, we might want to implement a "delayed update" functionality, ie, using the I/O update pin on the DAC or similar. Thus, upon receiving a trigger, the Arduino immediately propagate an I/O update on each of the devices, then write the n+1 instruction in the SetList to prep for the next output.</p>
<p>This might be facilitated by having an additional reserved short command, "h", to hold previous value (ie, don't trigger the I/O update).</p>
<p>It would be nice too if we had a manual controls equivalent &ndash; must ask Creston or Zach how manual controls is integrating new devices.</p>
<p>But, could consider a situation where "update hardware" in manual controls puts the Arduino in a different state, where it instantaneously updates the output of a given channel, eg, with the command "@m". For example, update hardware -&gt; "@m", then the sequence of commands eg, f 1 100; r 2 100 200 ...; etc. After each command is received, it knows to update NOW rather than wait for a triggered pulse. To put the Arduino back into cycle control, it would just wait for the negotiation of a new SetList via "@ (int)channelNum (int)numCommands", etc.</p>
<p>This hopefully catches a pretty broad swath of uses, and will be customizable enough to be reusable. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Mon Sep 22 2014 10:44:14 for JQI Arduino Libraries by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.8
</small></address>
</body>
</html>
