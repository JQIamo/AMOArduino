<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.8"/>
<title>JQI Arduino Libraries: SetListArduino</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="180px-JQI_logo_boxed.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">JQI Arduino Libraries
   </div>
   <div id="projectbrief">Arduino for the modern scientist.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.8 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title"><a class="el" href="class_set_list_arduino.html" title="Primary &quot;front-facing&quot; class for the SetListArduino library. ">SetListArduino</a> </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2>Overview</h2>
<p><a class="el" href="class_set_list_arduino.html" title="Primary &quot;front-facing&quot; class for the SetListArduino library. ">SetListArduino</a> is an Arduino library designed to provide easy integration for Arduino-controlled devices into the SetList computer control software used at the JQI. To set up a new Arduino device for SetList control, simply "register" the device with <a class="el" href="class_set_list_arduino.html" title="Primary &quot;front-facing&quot; class for the SetListArduino library. ">SetListArduino</a> in your sketch, and provide as many callback functions as you need to implement the desired functionality. <a class="el" href="class_set_list_arduino.html" title="Primary &quot;front-facing&quot; class for the SetListArduino library. ">SetListArduino</a> orchestrates the communication between LabView's SetList and each registered device, executing the appropriate callback function for each new line passed from SetList.</p>
<p>For examples and more details, see below!</p>
<h2>Example Sketch</h2>
<p>Here is a short sketch to illustrate how one might integrate an <a class="el" href="class_a_d9954.html">AD9954</a> DDS board.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;SPI.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="_a_d9954_8h.html">AD9954.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="_set_list_arduino_8h.html">SetListArduino.h</a>&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="comment">// Instantiate setlist object.</span></div>
<div class="line"><span class="comment">// Note, it must be called SetListImage for trigger interrupts to work.</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define triggerChannel 13</span></div>
<div class="line"><a class="code" href="class_set_list_arduino.html">SetListArduino</a> <a class="code" href="_set_list_arduino_8cpp.html#a457186a9c749dbc66614fd861f87655a">SetListImage</a>(triggerChannel); </div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">// Instantiate DDS object, using the AD9954 library.</span></div>
<div class="line"><span class="comment">// Exact instantiation depends on how DDS is connected.</span></div>
<div class="line"><span class="comment">// This could just as easily be any other device the </span></div>
<div class="line"><span class="comment">// Arduino knows how to communicate with, or even the</span></div>
<div class="line"><span class="comment">// digital/analog outputs of the Arduino itself! </span></div>
<div class="line"><span class="comment">// SetListArduino is completely device-agnostic, which </span></div>
<div class="line"><span class="comment">// allows for easy extensibility.</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define D1IOUPDATE 2</span></div>
<div class="line"><span class="preprocessor">#define D1PS1 3</span></div>
<div class="line"><span class="preprocessor">#define D1PS0 4</span></div>
<div class="line"><span class="preprocessor">#define D1OSK 5</span></div>
<div class="line"><span class="preprocessor">#define D1SS 6</span></div>
<div class="line"><span class="preprocessor">#define D1RESET 7</span></div>
<div class="line"></div>
<div class="line"><a class="code" href="class_a_d9954.html">AD9954</a> DDS(D1SS, D1RESET, D1IOUPDATE, D1PS0, D1PS1, D1OSK);    </div>
<div class="line"></div>
<div class="line"><span class="comment">// Callback function to set a particular DDS frequency</span></div>
<div class="line"><span class="comment">// We know that LabView will pass a single parameter for the frequency, thus</span></div>
<div class="line"><span class="comment">// we want to pull freq = params[0].</span></div>
<div class="line"><span class="keywordtype">void</span> setDDSFreq(<a class="code" href="class_a_d9954.html">AD9954</a> * dds, <span class="keywordtype">int</span> * params){</div>
<div class="line">    dds-&gt;<a class="code" href="class_a_d9954.html#a6f1215b712be7981ccad3fcc550b321f">setFreq</a>(params[0]);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Callback function to initiate a DDS ramp.</span></div>
<div class="line"><span class="comment">// Say we set this up so LabView will pass the parameters </span></div>
<div class="line"><span class="comment">// [freq0, freq1, tau] where tau is the ramp time.</span></div>
<div class="line"><span class="comment">// Here, we do a few calculations, initialize the pins, and call linearSweep</span></div>
<div class="line"><span class="comment">// on the DDS. The Arduino is controlling PS0 to do the sweep; see AD9954</span></div>
<div class="line"><span class="comment">// for details.</span></div>
<div class="line"><span class="keywordtype">void</span> rampDDS(<a class="code" href="class_a_d9954.html">AD9954</a> * dds, <span class="keywordtype">int</span> * params){</div>
<div class="line">    <span class="keywordtype">int</span> f0 = params[0];</div>
<div class="line">    <span class="keywordtype">int</span> f1 = params[1];</div>
<div class="line">    <span class="keywordtype">int</span> tau = params[2];</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">double</span> rampRate;</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">int</span> delta = f1 - f0;    <span class="comment">// calculate delta frequency</span></div>
<div class="line">    <span class="keywordtype">int</span> RR = 1;             <span class="comment">// number of SYS_CLK cycles to spend at each</span></div>
<div class="line">                            <span class="comment">// intermediate frequency</span></div>
<div class="line">    rampRate = ((double) delta)/tau;   <span class="comment">// Hz per second</span></div>
<div class="line">    <span class="keywordtype">int</span> posDF = (int)(rampRate * RR * 100E-9);   <span class="comment">// calculate posDF for DDS</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">// this is implemented in the AD9954 library; see that</span></div>
<div class="line">    <span class="comment">// documentation for details.</span></div>
<div class="line"></div>
<div class="line">    dds-&gt;<a class="code" href="class_a_d9954.html#a26d0f9e3f3053ffecdb58d1900a755de">linearSweep</a>(f0, f1, posDF, RR, posDF, RR);</div>
<div class="line">    digitalWrite(D1PS1, HIGH);  <span class="comment">// DDS starts sweeping...</span></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> setup(){</div>
<div class="line"></div>
<div class="line">    Serial.begin(9600);</div>
<div class="line"></div>
<div class="line">    SPI.begin();</div>
<div class="line">    SPI.setClockDivider(4);</div>
<div class="line">    SPI.setDataMode(SPI_MODE0);</div>
<div class="line"></div>
<div class="line">    DDS.initialize(400000000);  <span class="comment">// Start DDS with 400MHz clock</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">/*****************************************</span></div>
<div class="line"><span class="comment">        SetListArduino Part!</span></div>
<div class="line"><span class="comment">    ******************************************/</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">// Register the DDS device with SetListImage.</span></div>
<div class="line">    <span class="comment">// First argument is device (passed by reference);</span></div>
<div class="line">    <span class="comment">// Second argument is the &quot;channel number&quot;, which must match</span></div>
<div class="line">    <span class="comment">// what you entered in LabView. See README for more details.</span></div>
<div class="line">    <a class="code" href="_set_list_arduino_8cpp.html#a457186a9c749dbc66614fd861f87655a">SetListImage</a>.<a class="code" href="class_set_list_arduino.html#a684eb215a00c94d6c2113ef7a61be096">registerDevice</a>(DDS, 0);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Register as many callback functions as you need...</span></div>
<div class="line">    <span class="comment">// This says the short-command &quot;f&quot; on channel 0 should execute</span></div>
<div class="line">    <span class="comment">// the callback function setDDSFreq().</span></div>
<div class="line">    <a class="code" href="_set_list_arduino_8cpp.html#a457186a9c749dbc66614fd861f87655a">SetListImage</a>.<a class="code" href="class_set_list_arduino.html#a632bd0e945344749143fbe7dbb138a01">registerCommand</a>(<span class="stringliteral">&quot;f&quot;</span>, 0, setDDSFreq);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Here is another callback function, providing a method to </span></div>
<div class="line">    <span class="comment">// execute DDS ramps. Note, the short-command is different, but</span></div>
<div class="line">    <span class="comment">// we still want this functionality for our DDS on channel 0.</span></div>
<div class="line">    <span class="comment">// If we had a second DDS, say on channel 1, we would have to do a </span></div>
<div class="line">    <span class="comment">// second SetListImage.registerCommand(&quot;r&quot;, 1, rampDDS);</span></div>
<div class="line">    <a class="code" href="_set_list_arduino_8cpp.html#a457186a9c749dbc66614fd861f87655a">SetListImage</a>.<a class="code" href="class_set_list_arduino.html#a632bd0e945344749143fbe7dbb138a01">registerCommand</a>(<span class="stringliteral">&quot;r&quot;</span>, 0, rampDDS);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> loop(){</div>
<div class="line">    <a class="code" href="_set_list_arduino_8cpp.html#a457186a9c749dbc66614fd861f87655a">SetListImage</a>.<a class="code" href="class_set_list_arduino.html#a13ae88af6c307c7a1784cce29b1b8de8">readSerial</a>();  <span class="comment">// listen for &amp; process serial commands </span></div>
<div class="line">                                <span class="comment">// from computer</span></div>
<div class="line">}</div>
</div><!-- fragment --><h2>Limitations &amp; Important Notes</h2>
<p>There are a few <code>#define</code> statements in <code><a class="el" href="_set_list_arduino_8h.html">SetListArduino.h</a></code> to be aware of. If you want to overwrite these, do so before including <code><a class="el" href="_set_list_arduino_8h.html">SetListArduino.h</a></code> in your Arduino sketch.</p>
<ul>
<li><code>#define MAX_SETLIST_LINES 512</code> &ndash; SetList array size; don't make a setlist with more than 512 lines!</li>
<li><code>#define MAX_DEVICE_NUMBER 6</code> &ndash; deviceList array size. If you want more than 6 devices connected to a single Arduino, you'll need to increase this.</li>
<li><code>#define MAX_PARAM_NUM 8</code> &ndash; Parameter array size. This limits the number of parameters that will be parsed from the serial stream; if you need more than 8, be sure to redefine this!</li>
<li><code>#define SERIALCOMMAND_BUFFER 512</code> &ndash; Buffer length for serial commands. This limits a single serial line to 512 characters, which should hopefully be enough.</li>
<li><code>#define SERIALCOMMAND_MAXCOMMANDLENGTH 8</code> &ndash; Max length of "short command." But to be economical, you should try to limit your short commands to a single character.</li>
<li><code>#define SETLIST_ERROR_CHECK 1</code> &ndash; Sends error info back to LabView</li>
<li><code>#define SETLIST_DEBUG</code> &ndash; If you want debug info printed back to the serial stream, make sure to define this.</li>
</ul>
<h3>Device Channels - Important!</h3>
<p>The "device channel" (see <code>registerDevice()</code> below) corresponds directly to an index in _deviceList. Thus, make sure your channels start at 0 and are sequential. If you don't do this, the Arduino may segfault as it tries to execute functions in memory that has not been properly initialized.</p>
<h3>No "ramp" on first SetList line</h3>
<p>Because of idiosyncrasies in how we decided to trigger the Arduino, <a class="el" href="class_set_list_arduino.html" title="Primary &quot;front-facing&quot; class for the SetListArduino library. ">SetListArduino</a> will immediately initialize all devices with the callback given on the first line, and wait for a falling edge trigger to move to line #2. Thus, if you have some non-static output behavior on line #1, it will begin before the official "start" of the cycle.</p>
<p>The reason for this triggering behavior is that SetList (LabView edition) passes a single state per SetList line to a slaved digital channel on the PulseBlaster; if your SetList has an odd number of lines, you might end in the same state as the first SetList line, and thus not actually send a trigger for the first line.</p>
<p>Ultimately, this is a bug which should be fixed.</p>
<h3>SetListImage vs <a class="el" href="class_set_list_arduino.html" title="Primary &quot;front-facing&quot; class for the SetListArduino library. ">SetListArduino</a></h3>
<p><code><a class="el" href="class_set_list_arduino.html" title="Primary &quot;front-facing&quot; class for the SetListArduino library. ">SetListArduino</a></code> is the name of the class which orchestrates the SetList computer control, while <code>SetListImage</code> is the instance name you want to use.</p>
<p>Doing it this way allows us to actually attach trigger interrupts properly, since the interrupts need to know which class instance methods to call. Since <code><a class="el" href="class_set_list_arduino.html" title="Primary &quot;front-facing&quot; class for the SetListArduino library. ">SetListArduino</a></code> really should be a singleton class, requiring the name you use to be <code>SetListImage</code> fixes this issue.</p>
<h2>General comments on <a class="el" href="class_set_list_arduino.html" title="Primary &quot;front-facing&quot; class for the SetListArduino library. ">SetListArduino</a> library structure</h2>
<p>The <a class="el" href="class_set_list_arduino.html" title="Primary &quot;front-facing&quot; class for the SetListArduino library. ">SetListArduino</a> library has two main classes: <code>class <a class="el" href="class_set_list_arduino.html" title="Primary &quot;front-facing&quot; class for the SetListArduino library. ">SetListArduino</a></code> and <code>class <a class="el" href="class_set_list_device.html" title="Template class implementation of Setlist, for device-specific behavior. ">SetListDevice</a></code>. The class <code><a class="el" href="class_set_list_arduino.html" title="Primary &quot;front-facing&quot; class for the SetListArduino library. ">SetListArduino</a></code> is what you mainly have to worry about when coding an Arduino sketch; it orchestrates all of the communication between LabView and the controlled devices connected to your Arduino.</p>
<p><code><a class="el" href="class_set_list_device.html" title="Template class implementation of Setlist, for device-specific behavior. ">SetListDevice</a></code> is a templated class which inherits from a generic class <code><a class="el" href="class_set_list_base.html" title="Parent container class for SetListDevice. ">SetListBase</a></code> (which does nothing by itself). When you register a device by calling <code>SetListImage.registerDevice(...)</code>, <code><a class="el" href="class_set_list_arduino.html" title="Primary &quot;front-facing&quot; class for the SetListArduino library. ">SetListArduino</a></code> will create an instance of <code><a class="el" href="class_set_list_device.html" title="Template class implementation of Setlist, for device-specific behavior. ">SetListDevice</a></code>. This instance of <code><a class="el" href="class_set_list_device.html" title="Template class implementation of Setlist, for device-specific behavior. ">SetListDevice</a></code> contains the SetList and pointers to any callbacks necessary to execute said SetList.</p>
<p>To make this more concrete, consider a DDS-type device we want to control (like in the example sketch above). Say I have already instantiated the device itself, call it <code>DDS1</code>. To make it computer controllable, I first need to register it with the singleton class object, <code>SetListImage</code>:</p>
<div class="fragment"><div class="line"><a class="code" href="_set_list_arduino_8cpp.html#a457186a9c749dbc66614fd861f87655a">SetListImage</a>.<a class="code" href="class_set_list_arduino.html#a684eb215a00c94d6c2113ef7a61be096">registerDevice</a>(DDS1, 0);</div>
</div><!-- fragment --><p><code><a class="el" href="class_set_list_arduino.html" title="Primary &quot;front-facing&quot; class for the SetListArduino library. ">SetListArduino</a></code> has now added the object <code>DDS1</code> to position 0 in an array data member it owns called <code>_deviceList</code>. I can register more devices if I wish, being sure to use sequentially increasing channel numbers so they are inserted properly into the array <code>_deviceList</code>.</p>
<p>Now, when I register a command, I need to tell the Arduino what serial character it should listen to during SetList programming, and what it should do when it receives such a command. To this effect, I use</p>
<div class="fragment"><div class="line"><span class="comment">// registerCommand(const char * command, int channel, Callback function)</span></div>
<div class="line"><a class="code" href="_set_list_arduino_8cpp.html#a457186a9c749dbc66614fd861f87655a">SetListImage</a>.<a class="code" href="class_set_list_arduino.html#a632bd0e945344749143fbe7dbb138a01">registerCommand</a>(<span class="stringliteral">&quot;f&quot;</span>, 0, setDDSFreq);</div>
<div class="line"></div>
<div class="line"><span class="comment">// somewhere else in your sketch...</span></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> setDDSFreq(<a class="code" href="class_a_d9954.html">AD9954</a> * dds, <span class="keywordtype">int</span> * params){</div>
<div class="line">...</div>
<div class="line">}</div>
</div><!-- fragment --><p>The callback function, <code>setDDSFreq</code>, must take two arguments: a pointer of the same type as the device you're trying to control (here it is <code><a class="el" href="class_a_d9954.html">AD9954</a></code>), and an <code>int *</code> pointer to a list of parameters. When a particular SetList line is executed, <code><a class="el" href="class_set_list_device.html" title="Template class implementation of Setlist, for device-specific behavior. ">SetListDevice</a></code> will call that function and pass it a pointer to your device (ie, DDS) and a pointer to the parameter array.</p>
<h3>Serial programming sequence of events</h3>
<p>Once you've uploaded your sketch with all the devices registered and command callbacks defined, etc., this is an example of what it expects to see from the serial stream:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;@ 0</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;f 100000</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;f 150000</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;f 150000</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;f 500000</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;@ 1</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;r 100 200 500</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;f 50000</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;r 100 200 700</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;r 200 200 200</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;$</div>
</div><!-- fragment --><p>What this means (and see the special short command summary in the next section) is:</p>
<ul>
<li>"Activate channel 0 for setlist programming"</li>
<li>Programs 4 setlist lines with short command <code>f</code>, each taking a single parameter</li>
<li>"Activate channel 1 for setlist programming"</li>
<li>Programs 4 setlist lines; some have short command <code>r</code>, some short command <code>f</code>; short command <code>r</code> takes 3 arguments.</li>
<li>Initialize for sequence to begin with command <code>$</code>.</li>
</ul>
<p>Something worth noting: If you have, eg, 2 DDS devices on the same Arduino, you don't need to create separate callback functions for the same behavior. As long as you register both, you can use the same callback. For example,</p>
<div class="fragment"><div class="line"><a class="code" href="_set_list_arduino_8cpp.html#a457186a9c749dbc66614fd861f87655a">SetListImage</a>.<a class="code" href="class_set_list_arduino.html#a632bd0e945344749143fbe7dbb138a01">registerCommand</a>(<span class="stringliteral">&quot;f&quot;</span>, 0, setDDSFreq);</div>
<div class="line"><a class="code" href="_set_list_arduino_8cpp.html#a457186a9c749dbc66614fd861f87655a">SetListImage</a>.<a class="code" href="class_set_list_arduino.html#a632bd0e945344749143fbe7dbb138a01">registerCommand</a>(<span class="stringliteral">&quot;f&quot;</span>, 1, setDDSFreq);</div>
<div class="line"><a class="code" href="_set_list_arduino_8cpp.html#a457186a9c749dbc66614fd861f87655a">SetListImage</a>.<a class="code" href="class_set_list_arduino.html#a632bd0e945344749143fbe7dbb138a01">registerCommand</a>(<span class="stringliteral">&quot;f&quot;</span>, 2, setPLLFreq);</div>
</div><!-- fragment --><p>Here, there are two different DDSs which implement the same kind of behavior (ie, "set a single-tone frequency"). They are on channels 0 and 1, so we register that behavior with <code><a class="el" href="class_set_list_arduino.html" title="Primary &quot;front-facing&quot; class for the SetListArduino library. ">SetListArduino</a></code>. There is also a PLL, which we might want to use the same short command for (eg, "f" for "frequency", to set a single-tone output frequency). But, because it is a different device type, we need a separate callback <code>setPLLFreq</code> which we would define elsewhere like</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> setPLLFreq(PLLDevice * pll, <span class="keywordtype">int</span> * params){</div>
<div class="line">    pll-&gt;setPLLFreq(params[0]);</div>
<div class="line">}</div>
</div><!-- fragment --><p>or something similar. Hopefully you're starting to get the gist.</p>
<h2>Special short commands</h2>
<p>There are a few specially reserved short commands:</p>
<ul>
<li><code>@</code> - activates a new device, eg, <code>@ 1</code> activates device on channel 1.</li>
<li><code>$</code> - initializes for new cycle. Call this when you want the Arduino ready to receive triggers from the PulseBlaster.</li>
<li><code>?</code> - echo setlist back to serial terminal.</li>
<li><code>#</code> - execute single setlist line, eg, <code># 0 5</code> executes (index) line 5 on channel 0. Note this is the <em>index</em> of the line, not the line number &ndash; the index counts from 0.</li>
</ul>
<h2>Triggering requirements</h2>
<p>Currently, as discussed briefly above, <code><a class="el" href="class_set_list_arduino.html" title="Primary &quot;front-facing&quot; class for the SetListArduino library. ">SetListArduino</a></code> immediately outputs the state for the first line after receiving the serial command <code>$</code> indicating a sequence is beginning. It advances to the next line upon a falling-edge trigger, and then switches the interrupt to listen for a falling- or rising-edge.</p>
<p>When it encounters said trigger, an ISR routine jumps in and loops over the list of registered devices, calling <code>_deviceList[index]-&gt;executeSetList(_line)</code> to execute the callbacks for the next line.</p>
<p>Because this is a single-threaded microcontroller, be cognizant of timing delays! In a spot check, it looks like a "simple" device which just toggles the output of a digital pin on the Arduino, there was a 6.25 us delay between the trigger edge and the pin state change. Depending on how many devices you have connected and how fast the Arduino can update each device, there may be a substantially longer delay before it actually updates an output.</p>
<p>For this reason, you also don't want triggers to come too soon after each other! As always, test offline before stretching to the limit.</p>
<p>At any rate, LabView should provide a single state change trigger for each ramp line in SetList where some controlled device needs to change its output. Thus, as long as you aren't changing outputs too quickly, you should be fine. Just be careful it is doing what you expect.</p>
<h2>Implementing Arduino I/O as a device</h2>
<p>As alluded to above, you can actually use the digital/analog output pins on the Arduino itself. Just register a device of type <code>int</code> (or some other dummy class). Then, in the callback function, change the output of your line as desired. You can get creative!</p>
<h2>Future Development</h2>
<p>For better timing, we might consider implementing a feature where the Arduino pre-programs a device (eg, <a class="el" href="class_a_d9954.html">AD9954</a> DDS) before the next SetList trigger. When the trigger arrives, it simply has to trigger a (fast) digital IO update on the controlled device. Or, if we care even more about timing, we could implement additional SlavedDigital channels in LabView to trigger the actual device IO update. At some level, however, it becomes necessary to use an FPGA for precise timing applications.</p>
<h2>Sr Lab Arduino-controlled devices...</h2>
<p>Currently, we have the Arduino controlling a few different devices in the Sr lab. These libraries are also in the AMOArduino repository, and documentation of the hardware should be on the <a href="https://jqi-wiki.physics.umd.edu">JQI wiki</a>.</p>
<ul>
<li>DDS boards<ul>
<li>Output single-tone frequencies</li>
<li>Output linear frequency sweeps</li>
<li>More complex functionality can be implemented (see <a class="el" href="class_a_d9954.html">AD9954</a> library).</li>
</ul>
</li>
<li><a class="el" href="class_a_d_f4350.html">ADF4350</a> PLLs</li>
<li><a class="el" href="class_a_d_f4107.html">ADF4107</a> PLLs, other Analog Devices PLL chips in use for OPLL Beatnote locking</li>
<li><a class="el" href="class_a_d536x.html">AD536x</a> DACs<ul>
<li>Library still needs some polishing; control 8- or 16-channel DAC chips from Analog Devices.</li>
<li>Again, could output single voltage or interpolated sweep. However, the intention here is to use these for analog channels that don't need updating during a cycle. </li>
</ul>
</li>
</ul>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Mon Sep 22 2014 16:04:59 for JQI Arduino Libraries by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.8
</small></address>
</body>
</html>
